import{r as n,j as e,x as B,G as $,z as F,A as z,i as _,v as R,y as b}from"./index-D7n0z3Iu.js";import{B as O}from"./backbutton--plrQyr-.js";const U=({formData:s,onChange:m,onSubmit:c,loading:o,setFormData:r})=>{const[y,f]=n.useState(!1);return n.useEffect(()=>{(async()=>{try{const i=await B.get("/orders/shipping/retrieve/");if(i.status===200||i.status===204){const S=i.data;Object.keys(S).length>0&&(r(j=>({...j,...S})),f(!0))}}catch(i){console.error("Failed to fetch shipping address",i)}})()},[r]),e.jsxs("form",{onSubmit:c,className:"shipping-form-container",children:[e.jsx("h2",{className:"title",children:y?"Edit Shipping Information":"Shipping Information"}),e.jsxs("div",{className:"form-input-group",children:[["full_name","email","phone_number","address1","address2","street","city","state","country","zipcode"].map(l=>e.jsx("input",{type:"text",name:l,placeholder:l.replace("_"," ").toUpperCase(),value:s[l]||"",onChange:m,required:l!=="address2",className:"input"},l)),e.jsx("button",{type:"submit",disabled:o,className:"button",children:o?"Submitting...":y?"Update & Continue":"Continue to Review"})]})]})},L=({cart:s,onBack:m,onConfirm:c,loading:o})=>e.jsxs("div",{className:"review-container",children:[e.jsx("h2",{className:"review-title",children:"Review Your Order"}),e.jsxs("div",{className:"section",children:[e.jsx("h3",{className:"title",children:"Items in Cart"}),s.cart_items.map(({product:r,quantity:y,total_price:f})=>e.jsxs("div",{className:"itemRow",children:[e.jsxs("span",{children:[r.name," × ",y]}),e.jsxs("span",{children:["$",f.toFixed(2)]})]},r.id)),e.jsxs("p",{className:"total",children:["Total: $",s.total_price.toFixed(2)]})]}),e.jsxs("div",{className:"section",children:[e.jsx("button",{onClick:m,className:"backBtn",children:"Back"}),e.jsx("button",{onClick:c,disabled:o,className:"confirmBtn",children:o?"Processing...":"Confirm and Pay"})]})]});function M(s){return $({attr:{role:"img",viewBox:"0 0 24 24"},child:[{tag:"path",attr:{d:"M18.864 19.826h-4.107l-3.227-9.393-2.28 9.39H5.143L0 4.65h4.217l4.354 13.128c1.558-4.4 2.534-8.5 1.021-13.128H13.7ZM20.57 4.174a15.705 15.705 0 0 1-3.425 4.171 17.095 17.095 0 0 1 3.425 5.56A17.116 17.116 0 0 1 24 8.345a15.734 15.734 0 0 1-3.43-4.17Z"},child:[]}]})(s)}const E=({cart:s,email:m,loading:c,setLoading:o,phoneNumber:r,orderId:y})=>{const f=[{id:"stripe",label:"Stripe",icon:e.jsx(F,{})},{id:"paypal",label:"PayPal",icon:e.jsx(z,{})},{id:"swish",label:"Swish",icon:e.jsx(M,{})}],l=async()=>{try{const t=localStorage.getItem("access_token"),g=await _.post("/payment/stripe/",{email:m,amount:s.total_price},{headers:t?{Authorization:`Bearer ${t}`}:{},withCredentials:!0}),{url:a}=g.data;if(a){const x=a.startsWith("http")?a:`https://${a}`;window.location.href=x}else console.error("Missing Stripe redirect URL.")}catch(t){console.error(t),alert("Stripe payment failed.")}},i=async()=>{if(!(s!=null&&s.total_price)||!r){alert("Please enter your phone number and ensure the cart is loaded.");return}try{const t=localStorage.getItem("access_token"),a=(await _.post("/payment/swish/setup/",{amount:s.total_price,phone_number:r},{headers:t?{Authorization:`Bearer ${t}`}:{},withCredentials:!0})).data.approval_url;a?window.location.href=a:console.error("Approval URL is undefined.")}catch(t){console.error("Swish setup error:",t),alert("Swish setup failed. Please check your phone number and try again.")}},S=async()=>{try{const t=localStorage.getItem("access_token"),g=await _.post("/payment/paypal/setup/",{email:m,amount:s.total_price,order_id:y},{headers:t?{Authorization:`Bearer ${t}`}:{},withCredentials:!0}),{approval_url:a}=g.data;a?window.location.href=a:alert("PayPal setup failed: Missing approval URL.")}catch(t){console.error("PayPal setup error:",t),alert("Something went wrong while setting up PayPal.")}},j=async t=>{switch(o(!0),t){case"stripe":await l();break;case"paypal":await S();break;case"swish":await i();break;default:alert("Unsupported payment method")}o(!1)};return e.jsxs("div",{className:"payment-container",children:[e.jsx("h2",{className:"title",children:"Choose Payment Method"}),e.jsx("div",{className:"section",children:f.map(({id:t,label:g,icon:a})=>e.jsxs("button",{onClick:()=>j(t),disabled:c,className:"button",children:[a,e.jsx("span",{children:g})]},t))}),e.jsxs("p",{className:"total",children:["Total to Pay: $",s.total_price.toFixed(2)]})]})},G=()=>{const[s,m]=n.useState(null),[c,o]=n.useState({full_name:"",email:"",phone_number:"",address1:"",address2:"",city:"",street:"",state:"",country:"",zipcode:""}),[r,y]=n.useState(null),[f,l]=n.useState(""),[i,S]=n.useState(null),[j,t]=n.useState(!1),[g,a]=n.useState(!1),[x,v]=n.useState(0),{setShowNav:N,setShowFooter:k}=R();n.useEffect(()=>{(async()=>{try{const p=localStorage.getItem("access_token"),w=p?{Authorization:`Bearer ${p}`}:{},{data:h}=await _.get("/cart/",{headers:w,withCredentials:!0}),A={...h,cart_items:h.cart_items.map(u=>({...u,price:typeof u.price=="string"?parseFloat(u.price):u.price,total_price:u.total_price!==void 0&&u.total_price!==null?Number(u.total_price):Number(u.price)*Number(u.quantity)}))};m(A)}catch{b.error("❌ Failed to load cart data.")}})()},[]);const C=d=>{const{name:p,value:w}=d.target;o(h=>({...h,[p]:w}))},P=async d=>{d.preventDefault(),t(!0);try{const p=localStorage.getItem("access_token"),w=p?{Authorization:`Bearer ${p}`}:{},{data:h}=await _.post("/orders/shipping/create/",c,{headers:w,withCredentials:!0});y(h.id),l(h.phone_number),v(1),b.success("✅ Shipping information saved.")}catch{b.error("❌ Failed to save shipping info")}finally{t(!1)}},I=async()=>{if(!r||!s){b.error("Missing shipping address or cart.");return}t(!0);try{const d=localStorage.getItem("access_token"),p=d?{Authorization:`Bearer ${d}`}:{},{data:w}=await _.post("/orders/create/",{shipping_address_id:r,total_price:s.total_price,phone_number:c.phone_number,delivery_frequency:"none"},{headers:p,withCredentials:!0}),h=w.order_id;S(h),v(2),b.success("✅ Order created successfully!")}catch(d){console.error(d),b.error("❌ Failed to create order.")}finally{t(!1)}};return n.useEffect(()=>(N(!1),k(!1),()=>{N(!0),k(!0)}),[N,k]),e.jsx("div",{className:"checkout",children:e.jsxs("div",{className:"checkout-container",children:[e.jsx(O,{}),e.jsxs("div",{className:"accordion",children:[e.jsxs("div",{className:`accordion-section ${x>=0?"active":"disabled"}`,children:[e.jsx("h2",{onClick:()=>v(0),children:"1. Shipping Information"}),x===0&&s&&e.jsx(U,{formData:c,setFormData:o,onChange:C,onSubmit:P,loading:j})]}),e.jsxs("div",{className:`accordion-section ${x>=1?"active":"disabled"}`,children:[e.jsx("h2",{onClick:()=>v(1),children:"2. Review Your Order"}),x===1&&s&&e.jsx(L,{cart:s,phoneNumber:f,shippingAddressId:r,onBack:()=>v(0),onConfirm:I,loading:j})]}),e.jsxs("div",{className:`accordion-section ${x>=2?"active":"disabled"}`,children:[e.jsx("h2",{onClick:()=>v(2),children:"3. Payment"}),x===2&&s&&i&&e.jsx(E,{cart:s,email:c.email,phoneNumber:f,loading:g,setLoading:a,orderId:i},i)]})]})]})})};export{G as default};
